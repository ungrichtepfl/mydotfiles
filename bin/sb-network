#!/bin/sh

. sb-theme

case "$BLOCK_BUTTON" in
    1) nm-connection-editor ;;
    6) sensible-terminal.sh -e "$EDITOR" "$0" ;;
esac

# icons for common interface types (no leading spaces)
wifiIcon="ðŸ“¶"
ethIcon="ðŸ”Œ"
vpnIcon=""
if command -v nmcli >/dev/null 2>&1; then
    if nmcli -t -f TYPE connection show --active 2>/dev/null | grep -qw vpn; then
        vpnIcon="ðŸ”’"
    else
        vpnIcon=""
    fi
fi

shown=0

# Display each wifi interface separately so each can have its own color
for f in /sys/class/net/w*; do
    [ -d "$f" ] || continue
    iface=$(basename "$f")
    [ "$(cat /sys/class/net/$iface/operstate 2>/dev/null)" = up ] || continue
    # get first IPv4 for this iface
    ip4=$(ip -o -4 addr show dev "$iface" 2>/dev/null | awk '{print $4}' | cut -d/ -f1 | head -n1)
    [ -n "$ip4" ] || continue

    ssid=""
    signal=""
    if command -v nmcli >/dev/null 2>&1; then
        ssid=$(nmcli -t -f GENERAL.CONNECTION device show "$iface" 2>/dev/null | cut -d: -f2 | sed 's/^ //')
        signal=$(nmcli -t -f IN-USE,SSID,SIGNAL dev wifi list ifname "$iface" 2>/dev/null | awk -F: '$1=="*" {print $3; exit}')
    fi
    ssid=$(echo "$ssid" | sed 's/^ *//; s/ *$//')
    signal=$(echo "$signal" | sed 's/^ *//; s/ *$//')

    color=""
    if [ -n "$signal" ]; then
        sig=$signal
        if [ "$sig" -lt 30 ]; then
            color=$critical
        elif [ "$sig" -lt 50 ]; then
            color=$warning
        else
            color=""
        fi
    fi

    display_name="$ssid"
    [ -z "$display_name" ] && display_name="$iface"
    line="$wifiIcon $display_name $ip4"
    [ -n "$signal" ] && line="$line ($signal%)"
    [ -n "$vpnIcon" ] && line="$line $vpnIcon"

    if [ -n "$color" ]; then
        display_noline "$line" "$color"
    else
        display_noline "$line"
    fi
    shown=1
done

# Display each ethernet interface separately
for f in /sys/class/net/e*; do
    [ -d "$f" ] || continue
    iface=$(basename "$f")
    [ "$(cat /sys/class/net/$iface/operstate 2>/dev/null)" = up ] || continue
    ip4=$(ip -o -4 addr show dev "$iface" 2>/dev/null | awk '{print $4}' | cut -d/ -f1 | head -n1)
    [ -n "$ip4" ] || continue

    line="$ethIcon $ip4"
    [ -n "$vpnIcon" ] && line="$line $vpnIcon"
    display_noline "$line"
    shown=1
done

# If nothing displayed but vpn present, show vpn alone
if [ "$shown" -eq 0 ]; then
    if [ -n "$vpnIcon" ]; then
        display_noline "$vpnIcon"
        shown=1
    fi
fi
if [ "$shown" -eq 1 ]; then
    echo # Add the newline to flush
fi
