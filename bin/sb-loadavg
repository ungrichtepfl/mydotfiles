#!/bin/sh
# Display the average CPU load.

. sb-theme

case "$BLOCK_BUTTON" in
    6) sensible-terminal.sh -e "$EDITOR" "$0" ;;
esac


# compute current CPU utilization by sampling /proc/stat
# read total and idle from first cpu line (idle includes iowait)
read total1 idle1 <<EOF
$(awk 'NR==1 {idle=$5+$6; for(i=2;i<=NF;i++) total+=$i; print total, idle}' /proc/stat)
EOF

sleep 0.2

read total2 idle2 <<EOF
$(awk 'NR==1 {idle=$5+$6; for(i=2;i<=NF;i++) total+=$i; print total, idle}' /proc/stat)
EOF

# compute percentage (integer) and clamp to 0..100
percent=$(awk "BEGIN {dt=$total2 - $total1; di=$idle2 - $idle1; if(dt<=0){print 0} else {u=(1 - di/dt)*100; if(u<0) u=0; if(u>100) u=100; printf \"%d\", u}}")

# color thresholds: warn >=50% (yellow), alert >=90% (red) — match i3status-rust cpu block
if [ "$percent" -ge 90 ]; then
    color=$critical
elif [ "$percent" -ge 50 ]; then
    color=$warning
else
    color=""
fi

# show only full percentage (integer)
display "   $(printf "%2s" "$percent")%" "$color"
