# vim: filetype=neomuttrc

#------------------------------------------------------------
# Vi Key Bindings, taken from /usr/share/neomutt/vim-keys/vim-keys.rc
#------------------------------------------------------------

# Moving around
bind attach,browser,index       g   noop
bind index,pager                M noop
bind index,pager                C noop
bind index                      gM show-log-messages
bind index,pager                CC copy-message
bind attach,browser,index       gg  first-entry
bind attach,browser,index       G   last-entry
bind pager                      g   noop
bind pager                      gg  top
bind pager                      G   bottom
bind pager                      k   previous-line
bind pager                      j   next-line

# Scrolling
bind attach,browser,pager,index \CF next-page
bind attach,browser,pager,index \CB previous-page
bind attach,browser,pager,index \Cu half-up
bind attach,browser,pager,index \Cd half-down
bind browser,pager              \Ce next-line
bind browser,pager              \Cy previous-line
bind index                      \Ce next-line
bind index                      \Cy previous-line

bind pager,index                d   noop
bind pager,index                dd  delete-message

# Mail & Reply
bind index                      \Cm list-reply # Doesn't work currently

# Threads
bind browser,pager,index        N   search-opposite
bind pager,index                dT  delete-thread
bind pager,index                dt  delete-subthread
bind pager,index                gt  next-thread
bind pager,index                gT  previous-thread
bind index                      za  collapse-thread
bind index                      zA  collapse-all # Missing :folddisable/foldenable

#------------------------------------------------------------
# End Vi Key Bindings
#------------------------------------------------------------

# ADDITIONAL REBINDINGS
bind browser                    h   goto-parent
bind index                      h   noop
bind pager,attach               h   exit
bind index                      \Ct toggle-new
bind index                      D   purge-message
bind pager                      l   view-attachments
bind index                      l   display-message
bind browser                    l   select-entry
bind attach                     l   view-attach
bind index                      gl  limit
bind index,pager                R   group-reply
bind index                      za  collapse-thread
bind index                      zA  collapse-all # Missing :folddisable/foldenable

# sidebar mappings
bind index,pager                \Ck sidebar-prev
bind index,pager                \Cj sidebar-next
bind index,pager                \Co sidebar-open
bind index,pager                \Cp sidebar-prev-new
bind index,pager                \Cn sidebar-next-new
bind index,pager                B   sidebar-toggle-visible

# MACROS

macro index,pager gu "<enter-command>unset wait_key<enter><pipe-entry> urlscan<Enter><enter-command>set wait_key=yes<enter>"\
               "call urlscan to extract URLs out of a message"
macro attach,compose gu "<enter-command>unset wait_key<enter><pipe-entry> urlscan<Enter><enter-command>set wait_key=yes<enter>"\
               "call urlscan to extract URLs out of a message"
# Search using notmuch
bind index S vfolder-from-query
# NOTE: Mostly copied from muttwizard: https://github.com/LukeSmithxyz/mutt-wizard/blob/master/share/mutt-wizard.muttrc
macro index                     L "<enter-command>unset wait_key<enter><shell-escape>printf 'Enter a search term to find with notmuch: '; read x; echo \$x >\"\${XDG_CACHE_HOME:-\$HOME/.cache}/mutt_terms\"<enter><limit>~i \"\`notmuch search --output=messages \$(cat \"\${XDG_CACHE_HOME:-\$HOME/.cache}/mutt_terms\") | head -n 600 | perl -le '@a=<>;s/\^id:// for@a;$,=\"|\";print@a' | perl -le '@a=<>; chomp@a; s/\\+/\\\\+/g for@a; s/\\$/\\\\\\$/g for@a;print@a' \`\"<enter><enter-command>set wait_key=yes<enter>" "show only messages matching a notmuch pattern"
# shows all messages again
macro index                     A "<limit>all\n" "show all messages (undo limit)"


macro index,pager gi "<change-folder>+INBOX<enter>" "go to inbox"
macro index,pager Mi ";<save-message>+INBOX<enter>" "move mail to inbox"
macro index,pager Ci ";<copy-message>+INBOX<enter>" "copy mail to inbox"
macro index,pager gd "<change-folder>+Drafts<enter>" "go to drafts"
macro index,pager Md ";<save-message>+Drafts<enter>" "move mail to drafts"
macro index,pager Cd ";<copy-message>+Drafts<enter>" "copy mail to drafts"
macro index,pager gj "<change-folder>+Junk<enter>" "go to junk"
macro index,pager Mj ";<save-message>+Junk<enter>" "move mail to junk"
macro index,pager Cj ";<copy-message>+Junk<enter>" "copy mail to junk"
macro index,pager gt "<change-folder>+Trash<enter>" "go to trash"
macro index,pager Mt ";<save-message>+Trash<enter>" "move mail to trash"
macro index,pager Ct ";<copy-message>+Trash<enter>" "copy mail to trash"
macro index,pager gs "<change-folder>+Sent<enter>" "go to sent"
macro index,pager Ms ";<save-message>+Sent<enter>" "move mail to sent"
macro index,pager Cs ";<copy-message>+Sent<enter>" "copy mail to sent"
macro index,pager ga "<change-folder>+Archive<enter>" "go to archive"
macro index,pager Ma ";<save-message>+Archive<enter>" "move mail to archive"
macro index,pager Ca ";<copy-message>+Archive<enter>" "copy mail to archive"

# Virtual mailboxes
macro index,pager gf "<change-vfolder>Flagged<enter>" "go to flagged virtual mailbox"

macro index \Ca "T~U<enter><tag-prefix><clear-flag>N<untag-pattern>.<enter>" "mark all messages as read"

# Multipart composing
# https://jonathanh.co.uk/blog/multipart-emails-in-neomutt/
macro compose Y "<first-entry>\
<pipe-entry>~/.config/neomutt/convert_multipart.sh<enter>\
<enter-command>source /tmp/neomutt-commands<enter>"\
     "compose multipart emails"


